# Story 1.3: WebSocket Infrastructure Foundation

## Status
Draft

## Story
**As a** system administrator,  
**I want** to implement WebSocket server capabilities on the existing Express.js server,  
**so that** real-time communication features can be supported without affecting current HTTP endpoints.

## Acceptance Criteria
1. WebSocket server upgrade capability added to existing Express.js application
2. Current HTTP endpoints and middleware stack remain fully functional
3. WebSocket authentication integrates with existing JWT token system
4. Connection management includes automatic reconnection and cleanup mechanisms
5. Graceful degradation to HTTP polling if WebSocket connections fail

## Tasks / Subtasks
- [ ] Install and configure Socket.io infrastructure (AC: 1, 2)
  - [ ] Add Socket.io dependency and configure with Express.js server
  - [ ] Implement WebSocket server upgrade without disrupting HTTP endpoints
  - [ ] Create WebSocket namespace organization for different features
  - [ ] Configure CORS and security settings for WebSocket connections
- [ ] Implement JWT authentication for WebSocket connections (AC: 3)
  - [ ] Create WebSocket authentication middleware using existing JWT system
  - [ ] Implement token validation on connection handshake
  - [ ] Add user session management for WebSocket connections
  - [ ] Create role-based access control for WebSocket namespaces
- [ ] Build connection management system (AC: 4)
  - [ ] Implement automatic reconnection logic with exponential backoff
  - [ ] Create connection cleanup mechanisms for graceful disconnections
  - [ ] Add connection pooling and resource management
  - [ ] Implement heartbeat/ping-pong for connection health monitoring
- [ ] Create graceful degradation system (AC: 5)
  - [ ] Implement HTTP polling fallback endpoints for real-time features
  - [ ] Create connection status detection and automatic fallback
  - [ ] Add client-side reconnection strategies
  - [ ] Ensure feature parity between WebSocket and polling modes
- [ ] Setup monitoring and logging infrastructure
  - [ ] Add WebSocket connection metrics and monitoring
  - [ ] Implement structured logging for WebSocket events
  - [ ] Create performance monitoring for concurrent connections
  - [ ] Add error tracking and debugging capabilities
- [ ] Integration testing and validation (AC: 1, 2)
  - [ ] Test WebSocket server alongside existing HTTP functionality
  - [ ] Validate authentication integration with current JWT system
  - [ ] Test concurrent connection handling (100+ users per NFR2)
  - [ ] Verify graceful degradation under various failure scenarios

## Dev Notes

### Previous Story Insights
**Story 1.1 Context**: Database schema includes `chat_messages` and `notifications` collections that will use WebSocket infrastructure for real-time delivery.
**Story 1.2 Context**: AI service infrastructure will utilize WebSocket connections for async analysis progress updates and notifications.

### Data Models
**Source: Story 1.1 database schema and PRD requirements**

**Database Collections to Utilize:**
- `chat_messages` - Real-time message delivery [Source: docs/stories/1.1.database-schema-enhancement.md]
- `notifications` - Event-driven notification delivery [Source: docs/stories/1.1.database-schema-enhancement.md]
- `session_metrics` - Real-time session tracking and updates [Source: docs/stories/1.1.database-schema-enhancement.md]

**WebSocket Event Schemas:**
```typescript
// Real-time message events
interface MessageEvent {
  type: 'message_sent' | 'message_edited' | 'message_deleted';
  messageId: string;
  courseId?: string;
  channelId?: string;
  senderId: string;
  content?: string;
  timestamp: Date;
}

// Notification events
interface NotificationEvent {
  type: 'notification_new' | 'notification_read';
  notificationId: string;
  userId: string;
  notificationType: 'CNN_ANALYSIS_COMPLETE' | 'PEER_CONNECTION' | 'ASSIGNMENT_DUE' | 'NEW_MESSAGE' | 'SYSTEM_UPDATE';
  title: string;
  message: string;
  priority: 'LOW' | 'NORMAL' | 'HIGH' | 'URGENT';
}

// Analytics and progress events
interface ProgressEvent {
  type: 'analysis_progress' | 'analysis_complete' | 'session_update';
  userId: string;
  analysisId?: string;
  progress?: number;
  data: Record<string, any>;
}
```

### API Specifications
**Source: PRD Integration Strategy and backend architecture**

**WebSocket Namespaces:** [Source: docs/backend-architecture.md#Real-time Layer]
- `/chat` - Real-time messaging functionality
- `/notifications` - Event-driven notifications
- `/analytics` - Real-time analytics and progress updates
- `/collaboration` - Collaborative features and annotations

**Authentication Integration:** [Source: existing JWT patterns]
- Reuse existing JWT tokens for WebSocket authentication
- Maintain current user role verification (STUDENT, PROFESSOR, ADMIN)
- Integrate with existing authentication middleware patterns

**HTTP Fallback Endpoints:** [Source: PRD NFR5 graceful degradation]
- `GET /api/realtime/messages/:courseId` - Polling endpoint for messages
- `GET /api/realtime/notifications/:userId` - Polling endpoint for notifications
- `POST /api/realtime/ping` - Connection health check endpoint
- `GET /api/realtime/status` - WebSocket server status endpoint

### Component Specifications
**Source: Backend architecture patterns and Socket.io integration**

**Socket.io Architecture:** [Source: docs/backend-architecture.md#Additional Technologies Needed]
- **Technology**: Socket.io 4.7.4 for WebSocket communication
- **Integration**: Required for CNN progress tracking and peer notifications
- **Patterns**: Observer pattern for real-time progress tracking

**Key Service Classes:**
```typescript
// WebSocket server management
class WebSocketServer {
  private io: Server;
  private authenticatedConnections: Map<string, Socket>;
  
  initialize(httpServer: http.Server): void;
  authenticateConnection(socket: Socket, token: string): Promise<boolean>;
  broadcastToRoom(room: string, event: string, data: any): void;
  handleGracefulShutdown(): Promise<void>;
}

// Connection management service
class ConnectionManager {
  trackConnection(userId: string, socket: Socket): void;
  cleanupConnection(userId: string): void;
  getActiveConnections(courseId?: string): Socket[];
  monitorConnectionHealth(): void;
}

// Event broadcasting service
class EventBroadcaster {
  broadcastMessage(messageEvent: MessageEvent): void;
  broadcastNotification(notificationEvent: NotificationEvent): void;
  broadcastProgress(progressEvent: ProgressEvent): void;
}
```

### File Locations
**Source: Current project structure and backend architecture**

**New Files to Create:**
- `backend/src/websocket/` - New directory for WebSocket infrastructure
  - `WebSocketServer.ts` - Main WebSocket server implementation
  - `ConnectionManager.ts` - Connection lifecycle management
  - `EventBroadcaster.ts` - Event broadcasting service
  - `AuthMiddleware.ts` - WebSocket authentication middleware
  - `namespaces/` - Namespace-specific handlers
    - `ChatNamespace.ts` - Chat functionality handler
    - `NotificationNamespace.ts` - Notification handler
    - `AnalyticsNamespace.ts` - Analytics and progress handler
    - `CollaborationNamespace.ts` - Collaboration features handler
  - `types.ts` - WebSocket event types and interfaces
- `backend/src/routes/realtime.ts` - HTTP fallback endpoints
- `backend/src/middleware/websocketAuth.ts` - WebSocket-specific auth middleware
- `backend/src/services/eventService.ts` - Event management service

**Files to Modify:**
- `backend/src/server.ts` - Integrate Socket.io with Express server
- `backend/package.json` - Add Socket.io dependency
- `backend/.env.example` - Add WebSocket configuration variables

### Testing Requirements
**Source: PRD Testing Integration Strategy and NFR requirements**

**Testing Framework:** Vitest + Testing Library + Socket.io testing utilities [Source: docs/prd.md#Testing Integration Strategy]

**Required Tests:**
1. **Unit Tests** (`backend/tests/websocket/`)
   - Test WebSocket server initialization and configuration
   - Test authentication middleware with existing JWT system
   - Test connection management and cleanup mechanisms
   - Test event broadcasting functionality

2. **Integration Tests** (`backend/tests/integration/`)
   - Test WebSocket integration with existing Express.js server
   - Verify HTTP endpoints remain functional with WebSocket upgrade
   - Test database integration with real-time events
   - Validate graceful degradation to HTTP polling

3. **Performance Tests** (`backend/tests/performance/`)
   - Test concurrent connection handling (100+ users per NFR2)
   - Benchmark message delivery latency (under 200ms per NFR2)
   - Test memory usage and connection pooling efficiency
   - Validate server stability under connection churn

**WebSocket Testing Strategy:**
- Use Socket.io-client for testing WebSocket connections
- Mock JWT tokens for authentication testing
- Test both successful connections and failure scenarios
- Validate event ordering and delivery guarantees

### Technical Constraints
**Source: PRD Non-Functional Requirements and backend architecture**

**Performance Requirements:** [Source: docs/prd.md#NFR2, NFR5]
- Support minimum 100 concurrent users per course
- Message delivery latency under 200ms
- Graceful degradation to HTTP polling if WebSocket connections fail
- No interference with existing HTTP endpoints and file processing

**Technology Constraints:** [Source: docs/backend-architecture.md#Tech Stack]
- Express.js 5.1.0 integration without breaking existing middleware
- Node.js 20.11.0 LTS compatibility
- TypeScript strict mode compliance
- Integration with existing security middleware (Helmet, CORS)

**Security Requirements:**
- WebSocket connections must use existing JWT authentication
- CORS configuration for WebSocket connections
- Rate limiting for WebSocket events to prevent abuse
- Secure WebSocket (WSS) in production environments

**Reliability Requirements:**
- Automatic reconnection with exponential backoff
- Connection health monitoring with heartbeat/ping-pong
- Graceful handling of server restarts and deployments
- Resource cleanup to prevent memory leaks

### External Dependencies
**New NPM Packages Required:**
```json
{
  "socket.io": "^4.7.4",
  "@types/socket.io": "^3.0.x"
}
```

**Environment Variables:**
```bash
# WebSocket Configuration
WEBSOCKET_CORS_ORIGIN=http://localhost:5173
WEBSOCKET_PING_TIMEOUT=60000
WEBSOCKET_PING_INTERVAL=25000
WEBSOCKET_MAX_CONNECTIONS=1000

# Graceful Degradation
ENABLE_WEBSOCKET_FALLBACK=true
POLLING_INTERVAL=5000
```

### Integration Points
**Existing System Integration:** [Source: docs/backend-architecture.md]
- **Express.js Middleware**: Maintain existing security and rate limiting
- **JWT Authentication**: Extend existing auth system to WebSocket connections
- **Database Integration**: Use existing Prisma client for real-time data operations
- **Logging**: Integrate with existing Morgan HTTP logging patterns

## Testing

### Testing Standards
**Source: PRD Testing Integration Strategy**

**Test Framework:** Vitest + Testing Library + Socket.io testing utilities
**Test File Location:** `backend/tests/` directory following current patterns
**Testing Patterns:** Maintain current testing patterns while adding WebSocket-specific tests

**Required Testing Approaches:**
1. **Unit Tests:** WebSocket server components and authentication
2. **Integration Tests:** Express.js and WebSocket coexistence
3. **Performance Tests:** Concurrent connections and latency validation
4. **End-to-End Tests:** Full WebSocket communication flows

**WebSocket Testing Requirements:**
- Test both WebSocket and HTTP fallback modes
- Mock external dependencies while testing real WebSocket connections
- Test connection lifecycle management (connect, disconnect, reconnect)
- Validate event delivery order and reliability

**Performance Testing Specific Requirements:**
- Load test with 100+ concurrent connections per course
- Measure message delivery latency (target: under 200ms)
- Test connection stability during high message throughput
- Validate graceful degradation performance under various failure conditions

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-31 | 1.0 | Initial story creation with comprehensive WebSocket infrastructure context | Bob (Scrum Master) |
