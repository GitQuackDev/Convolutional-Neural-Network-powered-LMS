# Story 1.4: Basic Analytics Data Collection

## Status
Draft

## Story
**As a** educator,
**I want** the system to collect and store basic learning analytics data from existing user interactions,
**so that** comprehensive reporting can be built without disrupting current user workflows.

## Acceptance Criteria
1. Analytics collection middleware captures user interactions transparently
2. Data collection includes page views, content interactions, and CNN analysis usage
3. Privacy controls respect existing user consent and data protection settings
4. Analytics data collection doesn't impact existing page load performance
5. Collected data is structured for future dashboard and reporting features

## Tasks / Subtasks

- [ ] Create analytics middleware for data collection (AC: 1, 2)
  - [ ] Implement `AnalyticsMiddleware.ts` with request/response tracking
  - [ ] Add user interaction event capture (page views, clicks, form submissions)
  - [ ] Add CNN analysis usage tracking (analysis requests, results viewed)
  - [ ] Integrate with existing authentication middleware to capture user context
  
- [ ] Implement analytics data persistence service (AC: 2, 5)
  - [ ] Create `AnalyticsService.ts` for data storage operations
  - [ ] Implement user analytics data recording using `user_analytics` schema from Story 1.1
  - [ ] Implement session metrics tracking using `session_metrics` schema from Story 1.1
  - [ ] Add analytics data validation and sanitization

- [ ] Add privacy and consent management (AC: 3)
  - [ ] Check existing user consent before data collection
  - [ ] Implement opt-out mechanisms for analytics tracking
  - [ ] Add data anonymization for privacy compliance
  - [ ] Create privacy-compliant data retention policies

- [ ] Integrate with real-time WebSocket updates (AC: 5)
  - [ ] Connect to `/analytics` namespace from Story 1.3 WebSocket infrastructure
  - [ ] Emit real-time analytics events for live dashboard updates
  - [ ] Implement analytics data aggregation for real-time metrics

- [ ] Add performance monitoring and optimization (AC: 4)
  - [ ] Implement non-blocking analytics data collection
  - [ ] Add analytics processing queue for heavy operations
  - [ ] Monitor middleware performance impact on existing endpoints
  - [ ] Add analytics collection health checks

## Dev Notes

### Relevant Source Tree Information

**Existing Middleware Structure:**
- `backend/src/middleware/auth.ts` - JWT authentication with user context extraction
- `backend/src/middleware/errorHandler.ts` - Error handling patterns
- `backend/src/middleware/rateLimiter.ts` - Request rate limiting
- `backend/src/middleware/notFound.ts` - 404 handling

**Existing Routes Structure:**
- `backend/src/routes/cnn.ts` - CNN analysis endpoints (`/analyze`, `/analysis/:id`)
- `backend/src/routes/auth.ts` - Authentication endpoints
- `backend/src/routes/courses.ts` - Course management endpoints
- `backend/src/routes/assignments.ts` - Assignment endpoints
- `backend/src/routes/discussions.ts` - Discussion endpoints
- `backend/src/routes/users.ts` - User management endpoints

**Database Schema from Story 1.1:**
```typescript
// user_analytics collection schema
model UserAnalytics {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  userId     String   @db.ObjectId
  sessionId  String
  action     String   // 'page_view', 'click', 'form_submit', 'cnn_analysis'
  resource   String   // URL path or resource identifier
  metadata   Json?    // Additional context data
  timestamp  DateTime @default(now())
  ipAddress  String?
  userAgent  String?
  duration   Int?     // Time spent on action in milliseconds
  @@map("user_analytics")
}

// session_metrics collection schema  
model SessionMetrics {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  userId       String   @db.ObjectId
  sessionId    String   @unique
  sessionStart DateTime @default(now())
  sessionEnd   DateTime?
  pageViews    Int      @default(0)
  totalTime    Int      @default(0) // Total session time in milliseconds
  lastActivity DateTime @default(now())
  deviceInfo   Json?    // Browser, OS, screen resolution
  exitPage     String?
  @@map("session_metrics")
}
```

**WebSocket Integration from Story 1.3:**
- Analytics namespace available at `/analytics` for real-time updates
- Event emission pattern: `io.of('/analytics').emit('analytics-update', data)`
- Authenticated WebSocket connections using JWT tokens

**Technology Stack Context:**
- Express.js 5.1.0 middleware pattern
- MongoDB with Prisma ORM for data persistence
- TypeScript for type safety
- JWT authentication already implemented
- Existing error handling and rate limiting patterns

**Key Implementation Points:**
1. Analytics middleware should be added to Express middleware stack BEFORE route handlers
2. Must not interfere with existing middleware execution order
3. Should use existing JWT authentication context when available
4. Data collection must be non-blocking to avoid performance impact
5. Follow existing error handling patterns from `errorHandler.ts`

**Files to Create:**
- `backend/src/middleware/analytics.ts` - Main analytics collection middleware
- `backend/src/services/AnalyticsService.ts` - Data persistence service
- `backend/src/routes/analytics.ts` - Analytics API endpoints (for future dashboard)

**Files to Modify:**
- `backend/src/server.ts` - Add analytics middleware to Express app
- `backend/prisma/schema.prisma` - Already updated in Story 1.1

### Testing

**Test File Locations:**
- `backend/src/middleware/__tests__/analytics.test.ts` - Analytics middleware tests
- `backend/src/services/__tests__/AnalyticsService.test.ts` - Service layer tests

**Testing Frameworks:**
- Jest for unit testing
- Supertest for API endpoint testing  
- Test database setup using Prisma test environment

**Testing Requirements:**
1. **Unit Tests:**
   - Analytics middleware request/response tracking
   - Analytics service data validation and persistence
   - Privacy consent checking logic
   - WebSocket event emission

2. **Integration Tests:**
   - End-to-end analytics data flow from request to database
   - Performance impact measurement on existing endpoints
   - Real-time WebSocket analytics event delivery

3. **Privacy Compliance Tests:**
   - Opt-out functionality validation
   - Data anonymization verification
   - Consent management integration

**Testing Standards:**
- Minimum 80% code coverage for new analytics components
- Performance tests ensuring <10ms overhead per request
- Mock external dependencies (database, WebSocket connections)
- Use existing test patterns from `backend/src/__tests__/` directory

### Previous Story Context

**From Story 1.1 (Database Schema Enhancement):**
- `user_analytics` and `session_metrics` collections are available with proper indexes
- MongoDB schema extensions are backward compatible
- Indexes optimized for userId and timestamp queries

**From Story 1.2 (AI Model Service Infrastructure):**
- AI analysis results can be tracked via `ai_analysis_results` collection
- Service layer patterns established for business logic separation

**From Story 1.3 (WebSocket Infrastructure Foundation):**
- `/analytics` namespace configured for real-time analytics updates
- WebSocket authentication using JWT tokens implemented
- Event emission patterns established for real-time communication

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-01-08 | 1.0 | Initial story creation for basic analytics data collection | Scrum Master |
